Function XLookupWithDuplicates(lookupValue As Variant, lookupRange As Range, returnRange As Range) As Variant
    Dim lookupResult As Variant
    Dim cell As Range
    Dim matchingCells As Range
    Dim firstOccurrence As Variant
    Dim duplicateCount As Long
    
    ' Check for duplicates in the lookup value column
    duplicateCount = Application.CountIf(lookupRange.Columns(1), lookupValue)
    
    ' Find first occurrence
    firstOccurrence = Application.Match(lookupValue, lookupRange.Columns(1), 0)
    
    ' Check if duplicates exist
    If duplicateCount > 1 Then
        ' Collect matching cells
        Set matchingCells = lookupRange.Columns(1).SpecialCells(xlCellTypeConstants, xlTextValues)
        ' Loop through matching cells to find duplicates
        For Each cell In matchingCells
            If cell.Value = lookupValue Then
                ' Append cell address to the string
                If XLookupWithDuplicates <> "" Then
                    XLookupWithDuplicates = XLookupWithDuplicates & ", " & cell.Address
                Else
                    XLookupWithDuplicates = cell.Address
                End If
            End If
        Next cell
        ' Return message with cell addresses
        XLookupWithDuplicates = "Duplicates found in cells " & XLookupWithDuplicates
    Else
        ' No duplicates, perform initial XLOOKUP
        lookupResult = Application.XLookup(lookupValue, lookupRange.Columns(1), returnRange)
        XLookupWithDuplicates = lookupResult
    End If
End Function
